<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubio Garc√≠a Dental - Sistema de Gesti√≥n</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <img src="imgs/logo.svg" alt="Rubio Garc√≠a Dental" class="loading-logo">
            <h2>Cargando Sistema de Gesti√≥n</h2>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen hidden">
        <div class="login-container">
            <div class="login-header">
                <img src="imgs/logo.svg" alt="Rubio Garc√≠a Dental" class="login-logo">
                <h1>Acceso al Sistema</h1>
                <p>Sistema de Gesti√≥n Cl√≠nica</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="username" name="username" placeholder="Introduce tu usuario" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" name="password" placeholder="Introduce tu contrase√±a" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Iniciar Sesi√≥n</button>
            </form>
            <div class="login-footer">
                <p><strong>Usuario:</strong> JMD | <strong>Clave:</strong> 190582</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app hidden">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="imgs/logo.svg" alt="Rubio Garc√≠a Dental" class="sidebar-logo">
                <span class="sidebar-title">Rubio Garc√≠a Dental</span>
            </div>
            
            <ul class="sidebar-menu">
                <li class="menu-item active">
                    <a href="#" data-section="home">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Panel de Control</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-section="agenda">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Agenda</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-section="pacientes">
                        <i class="fas fa-users"></i>
                        <span>Pacientes</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-section="whatsapp">
                        <i class="fab fa-whatsapp"></i>
                        <span>WhatsApp</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-section="agente-ia">
                        <i class="fas fa-robot"></i>
                        <span>Agente IA</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-section="documentos">
                        <i class="fas fa-file-alt"></i>
                        <span>Documentos</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-section="facturas">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Facturas</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-section="contabilidad">
                        <i class="fas fa-chart-line"></i>
                        <span>Contabilidad</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-section="configuracion">
                        <i class="fas fa-cog"></i>
                        <span>Configuraci√≥n</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="breadcrumb">
                        <span id="currentSection">Panel de Control</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span>Juan Antonio Manzanedo</span>
                        <button class="btn btn-sm btn-outline" id="logoutBtn">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </header>

            <!-- Content Sections -->
            <div class="content-area">
                
                <!-- Home Section -->
                <section id="home" class="content-section active">
                    <div class="section-header">
                        <h1>Panel de Control</h1>
                        <p>Resumen general de la cl√≠nica</p>
                    </div>
                    
                    <div class="dashboard-grid">
                        <!-- Today's Appointments -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="fas fa-calendar-day"></i> Citas de Hoy</h3>
                                <span class="card-badge">12 citas</span>
                            </div>
                            <div class="card-content">
                                <div class="appointment-list" id="todayAppointments">
                                    <!-- Appointments will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="card-footer">
                                <a href="#" data-section="agenda" class="btn btn-link">Ver todas las citas</a>
                            </div>
                        </div>

                        <!-- Urgent Messages -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="fas fa-exclamation-triangle"></i> Mensajes Urgentes</h3>
                                <span class="card-badge warning">3 mensajes</span>
                            </div>
                            <div class="card-content">
                                <div class="message-list" id="urgentMessages">
                                    <!-- Urgent messages will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="card-footer">
                                <a href="#" data-section="whatsapp" class="btn btn-link">Ver todos los mensajes</a>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="fas fa-bolt"></i> Acciones R√°pidas</h3>
                            </div>
                            <div class="card-content">
                                <div class="quick-actions">
                                    <button class="action-btn" data-action="new-appointment">
                                        <i class="fas fa-plus"></i>
                                        <span>Nueva Cita</span>
                                    </button>
                                    <button class="action-btn" data-action="new-patient">
                                        <i class="fas fa-user-plus"></i>
                                        <span>Nuevo Paciente</span>
                                    </button>
                                    <button class="action-btn" data-action="send-message">
                                        <i class="fas fa-paper-plane"></i>
                                        <span>Enviar Mensaje</span>
                                    </button>
                                    <button class="action-btn" data-action="new-invoice">
                                        <i class="fas fa-file-invoice"></i>
                                        <span>Nueva Factura</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Statistics -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-bar"></i> Estad√≠sticas del D√≠a</h3>
                            </div>
                            <div class="card-content">
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-number">24</div>
                                        <div class="stat-label">Citas Completadas</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">‚Ç¨2,340</div>
                                        <div class="stat-label">Ingresos del D√≠a</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">8</div>
                                        <div class="stat-label">Nuevos Pacientes</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">98%</div>
                                        <div class="stat-label">Satisfacci√≥n</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Agenda Section -->
                <section id="agenda" class="content-section">
                    <div class="section-header">
                        <h1>Agenda de Citas</h1>
                        <div class="section-controls">
                            <div class="view-controls">
                                <button class="btn btn-sm" data-view="day">D√≠a</button>
                                <button class="btn btn-sm" data-view="week">Semana</button>
                                <button class="btn btn-sm active" data-view="month">Mes</button>
                            </div>
                            <button class="btn btn-primary" id="newAppointmentBtn">
                                <i class="fas fa-plus"></i> Nueva Cita
                            </button>
                        </div>
                    </div>

                    <div class="calendar-container">
                        <div class="calendar-header">
                            <h2 id="calendarTitle">Diciembre 2024</h2>
                            <div class="calendar-nav">
                                <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                                <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be populated by JavaScript -->
                        </div>
                    </div>
                </section>

                <!-- Pacientes Section -->
                <section id="pacientes" class="content-section">
                    <div class="section-header">
                        <h1>Base de Datos de Pacientes</h1>
                        <div class="section-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="patientSearch" placeholder="Buscar pacientes...">
                            </div>
                            <button class="btn btn-primary" id="newPatientBtn">
                                <i class="fas fa-plus"></i> Nuevo Paciente
                            </button>
                        </div>
                    </div>

                    <div class="patients-container">
                        <div class="patients-list" id="patientsList">
                            <!-- Patients will be populated by JavaScript -->
                        </div>
                    </div>
                </section>

                <!-- WhatsApp Section -->
                <section id="whatsapp" class="content-section">
                    <div class="section-header">
                        <h1>Centro de Mensajes WhatsApp</h1>
                        <div class="section-controls">
                            <button class="btn btn-primary" id="newMessageBtn">
                                <i class="fas fa-plus"></i> Nuevo Mensaje
                            </button>
                        </div>
                    </div>

                    <div class="whatsapp-container">
                        <div class="whatsapp-sidebar">
                            <div class="chat-list" id="chatList">
                                <!-- Chat list will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="whatsapp-main">
                            <div class="chat-header" id="chatHeader">
                                <div class="chat-info">
                                    <h3>Selecciona una conversaci√≥n</h3>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessages">
                                <div class="no-chat-selected">
                                    <i class="fab fa-whatsapp"></i>
                                    <h3>Selecciona una conversaci√≥n para empezar</h3>
                                    <p>Elige un paciente de la lista para ver el historial de mensajes</p>
                                </div>
                            </div>
                            <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                                <div class="chat-input">
                                    <button class="input-btn" id="attachFile">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <input type="text" id="messageInput" placeholder="Escribe un mensaje...">
                                    <button class="input-btn" id="sendMessage">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Agente IA Section -->
                <section id="agente-ia" class="content-section">
                    <div class="section-header">
                        <h1>Agente IA - Automatizaci√≥n</h1>
                        <div class="section-controls">
                            <div class="ai-status" id="aiStatus">
                                <span class="status-indicator active"></span>
                                <span>IA Activa</span>
                            </div>
                        </div>
                    </div>

                    <div class="ai-container">
                        <div class="ai-config">
                            <div class="config-section">
                                <h3>Configuraci√≥n del Comportamiento</h3>
                                <div class="form-group">
                                    <label>Estilo de Respuesta</label>
                                    <select id="aiResponseStyle">
                                        <option value="professional">Profesional</option>
                                        <option value="friendly">Amigable</option>
                                        <option value="formal">Formal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Tono de Comunicaci√≥n</label>
                                    <select id="aiCommunicationTone">
                                        <option value="calm">Tranquilo</option>
                                        <option value="enthusiastic">Entusiasta</option>
                                        <option value="empathetic">Emp√°tico</option>
                                    </select>
                                </div>
                            </div>

                            <div class="config-section">
                                <h3>Automatizaciones Activas</h3>
                                <div class="automation-list" id="activeAutomations">
                                    <!-- Automations will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <div class="ai-monitor">
                            <div class="monitor-section">
                                <h3>Actividad Reciente</h3>
                                <div class="activity-log" id="aiActivityLog">
                                    <!-- Activity will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sistema de Confirmaci√≥n de Citas Section -->
                <section id="confirmacion-citas" class="content-section">
                    <div class="section-header">
                        <h1>üì± Sistema de Confirmaci√≥n de Citas</h1>
                        <div class="section-controls">
                            <div class="confirmation-status">
                                <span class="status-indicator active"></span>
                                <span>Autom√°tico 24h</span>
                            </div>
                            <button class="btn btn-secondary" onclick="window.testAppointmentConfirmation()">
                                <i class="fas fa-vial"></i> Enviar Mensaje de Prueba
                            </button>
                        </div>
                    </div>

                    <div class="confirmation-container">
                        <!-- Panel de Estad√≠sticas -->
                        <div class="confirmation-stats" id="confirmationStats">
                            <div class="stat-card">
                                <h3>Mensajes Enviados</h3>
                                <div class="stat-number" id="totalMessagesSent">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Confirmadas</h3>
                                <div class="stat-number success" id="confirmedCount">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Canceladas</h3>
                                <div class="stat-number danger" id="cancelledCount">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Activas</h3>
                                <div class="stat-number warning" id="activeCount">0</div>
                            </div>
                        </div>

                        <!-- Panel de Configuraci√≥n -->
                        <div class="confirmation-config">
                            <div class="config-section">
                                <h3>‚öôÔ∏è Configuraci√≥n del Sistema</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Anticipaci√≥n del Mensaje</label>
                                        <select id="confirmationLeadTime">
                                            <option value="24">24 horas antes</option>
                                            <option value="12">12 horas antes</option>
                                            <option value="6">6 horas antes</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Modo de Env√≠o</label>
                                        <select id="confirmationMode">
                                            <option value="automatic">Autom√°tico</option>
                                            <option value="manual">Manual</option>
                                            <option value="mixed">Mixto</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Reintentos</label>
                                        <input type="number" id="confirmationRetries" value="3" min="1" max="5">
                                    </div>
                                    <div class="form-group">
                                        <label>Estado del Sistema</label>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="confirmationSystemToggle" checked>
                                            <label for="confirmationSystemToggle"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Plantillas de Respuesta -->
                            <div class="config-section">
                                <h3>üí¨ Plantillas de Respuesta Autom√°tica</h3>
                                <div class="response-templates">
                                    <div class="template-card">
                                        <h4>‚úÖ Mensaje de Confirmaci√≥n</h4>
                                        <textarea id="confirmationTemplate" rows="3">Muchas gracias por ayudarnos a mejorar nuestra atenci√≥n!</textarea>
                                    </div>
                                    <div class="template-card">
                                        <h4>‚ùå Mensaje de Cancelaci√≥n</h4>
                                        <textarea id="cancellationTemplate" rows="3">Desea que le demos una nueva cita</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel de Mensajes en Tiempo Real -->
                        <div class="confirmation-monitor">
                            <div class="monitor-header">
                                <h3>üì° Monitoreo en Tiempo Real</h3>
                                <div class="monitor-controls">
                                    <button class="btn btn-sm" onclick="window.confirmationSystem.cleanupCompletedConfirmations()">
                                        <i class="fas fa-broom"></i> Limpiar
                                    </button>
                                    <button class="btn btn-sm" onclick="updateConfirmationStats()">
                                        <i class="fas fa-sync"></i> Actualizar
                                    </button>
                                </div>
                            </div>
                            <div id="confirmationMessages" class="confirmation-messages">
                                <div class="empty-state">
                                    <i class="fas fa-comments"></i>
                                    <p>Los mensajes de confirmaci√≥n aparecer√°n aqu√≠ en tiempo real</p>
                                    <small>El sistema env√≠a autom√°ticamente mensajes 24 horas antes de cada cita</small>
                                </div>
                            </div>
                        </div>

                        <!-- Controles de Prueba -->
                        <div class="confirmation-test-controls">
                            <h4>üß™ Pruebas del Sistema</h4>
                            <p>Utiliza estos controles para probar el funcionamiento del sistema de confirmaci√≥n</p>
                            <div class="test-buttons">
                                <button class="btn btn-primary" onclick="testConfirmationFlow()">
                                    <i class="fas fa-play"></i> Probar Flujo Completo
                                </button>
                                <button class="btn btn-success" onclick="testConfirmationResponse()">
                                    <i class="fas fa-check"></i> Simular Confirmaci√≥n
                                </button>
                                <button class="btn btn-danger" onclick="testCancellationResponse()">
                                    <i class="fas fa-times"></i> Simular Cancelaci√≥n
                                </button>
                            </div>
                        </div>

                        <!-- Historial de Actividad -->
                        <div class="confirmation-history">
                            <div class="history-header">
                                <h3>üìã Historial de Actividad</h3>
                                <button class="btn btn-sm btn-secondary" onclick="exportConfirmationHistory()">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                            <div class="history-content" id="confirmationHistory">
                                <!-- El historial se cargar√° din√°micamente -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sistema de Automatizaci√≥n Avanzado Section -->
                <section id="automatizacion-avanzada" class="content-section">
                    <div class="section-header">
                        <h1>ü§ñ Sistema de Automatizaci√≥n Avanzado</h1>
                        <div class="section-controls">
                            <div class="automation-status">
                                <span class="status-indicator active"></span>
                                <span>Flujos Din√°micos</span>
                                <span class="lopd-compliance-badge">
                                    <i class="fas fa-shield-alt"></i>
                                    LOPD Compliant
                                </span>
                            </div>
                            <button class="btn btn-primary" onclick="window.testAdvancedAutomation()">
                                <i class="fas fa-play"></i> Probar Flujo Completo
                            </button>
                        </div>
                    </div>

                    <div class="automation-container">
                        <!-- Panel de Estados de Cita -->
                        <div class="appointment-states-panel">
                            <h3>üìä Estados de Cita Disponibles</h3>
                            <div class="states-grid">
                                <div class="state-badge state-planificada">
                                    <i class="fas fa-calendar-plus"></i>
                                    <span>Planificada</span>
                                </div>
                                <div class="state-badge state-confirmada">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Confirmada</span>
                                </div>
                                <div class="state-badge state-aceptada">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span>Aceptada</span>
                                    <small>(Confirmada + Consentimiento)</small>
                                </div>
                                <div class="state-badge state-cancelada">
                                    <i class="fas fa-times-circle"></i>
                                    <span>Cancelada</span>
                                </div>
                                <div class="state-badge state-anula">
                                    <i class="fas fa-ban"></i>
                                    <span>Anula</span>
                                </div>
                            </div>
                        </div>

                        <!-- Estad√≠sticas de Automatizaci√≥n -->
                        <div class="automation-stats-grid">
                            <div class="automation-stat-card">
                                <h3>Flujos Activos</h3>
                                <div class="stat-number" id="activeFlowsCount">0</div>
                            </div>
                            <div class="automation-stat-card">
                                <h3>Completados</h3>
                                <div class="stat-number success" id="completedFlowsCount">0</div>
                            </div>
                            <div class="automation-stat-card">
                                <h3>Documentos LOPD</h3>
                                <div class="stat-number info" id="lopdDocumentsCount">0</div>
                            </div>
                            <div class="automation-stat-card">
                                <h3>Cuestionarios</h3>
                                <div class="stat-number warning" id="questionnairesCount">0</div>
                            </div>
                        </div>

                        <!-- Configuraci√≥n de Flujos -->
                        <div class="automation-config">
                            <div class="config-section">
                                <h3>‚öôÔ∏è Configuraci√≥n de Automatizaci√≥n</h3>
                                <div class="config-grid">
                                    <div class="form-group">
                                        <label>Tipo de Flujo por Defecto</label>
                                        <select id="defaultFlowType">
                                            <option value="confirmation">Solo Confirmaci√≥n</option>
                                            <option value="mixed">Completo (Confirmaci√≥n + Legal)</option>
                                            <option value="questionnaire">Solo Cuestionario</option>
                                            <option value="document">Solo Documentos</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Verificaci√≥n Legal Obligatoria</label>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="legalVerificationToggle" checked>
                                            <label for="legalVerificationToggle"></label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Seguimiento LOPD</label>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="lopdTrackingToggle" checked>
                                            <label for="lopdTrackingToggle"></label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Tiempo de Respuesta</label>
                                        <select id="responseTimeout">
                                            <option value="300000">5 minutos</option>
                                            <option value="600000" selected>10 minutos</option>
                                            <option value="900000">15 minutos</option>
                                            <option value="1800000">30 minutos</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Documentos Legales -->
                            <div class="config-section">
                                <h3>‚öñÔ∏è Documentos Legales Requeridos</h3>
                                <div class="legal-documents-list">
                                    <div class="legal-document-item">
                                        <div class="document-info">
                                            <i class="fas fa-shield-alt"></i>
                                            <div class="document-details">
                                                <h4>Consentimiento LOPD</h4>
                                                <p>Ley de Protecci√≥n de Datos - Obligatorio</p>
                                                <span class="legal-status-indicator lopd-accepted">
                                                    <i class="fas fa-check"></i> Configurado
                                                </span>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-secondary" onclick="editLegalDocument('lopd_consent')">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                    </div>
                                    <div class="legal-document-item">
                                        <div class="document-info">
                                            <i class="fas fa-file-medical"></i>
                                            <div class="document-details">
                                                <h4>Consentimiento Informado</h4>
                                                <p>Para tratamientos m√©dicos - Obligatorio</p>
                                                <span class="legal-status-indicator consent-accepted">
                                                    <i class="fas fa-check"></i> Configurado
                                                </span>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-secondary" onclick="editLegalDocument('informed_consent_treatment')">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                    </div>
                                    <div class="legal-document-item">
                                        <div class="document-info">
                                            <i class="fas fa-clipboard-list"></i>
                                            <div class="document-details">
                                                <h4>Cuestionario Primera Visita</h4>
                                                <p>Historial m√©dico y dental - Obligatorio</p>
                                                <span class="legal-status-indicator consent-pending">
                                                    <i class="fas fa-clock"></i> Configurado
                                                </span>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-secondary" onclick="editLegalDocument('first_visit_questionnaire')">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Monitor de Flujos en Tiempo Real -->
                        <div class="automation-monitor">
                            <div class="monitor-header">
                                <h3>üì° Monitor de Flujos en Tiempo Real</h3>
                                <div class="monitor-controls">
                                    <button class="btn btn-sm" onclick="clearAutomationMonitor()">
                                        <i class="fas fa-broom"></i> Limpiar
                                    </button>
                                    <button class="btn btn-sm" onclick="refreshAutomationStats()">
                                        <i class="fas fa-sync"></i> Actualizar
                                    </button>
                                </div>
                            </div>
                            <div id="automationMessages" class="automation-messages">
                                <div class="empty-state">
                                    <i class="fas fa-robot"></i>
                                    <p>Los flujos de automatizaci√≥n aparecer√°n aqu√≠ en tiempo real</p>
                                    <small>El sistema crea flujos din√°micos basados en las respuestas del paciente</small>
                                </div>
                            </div>
                        </div>

                        <!-- Controles de Prueba Avanzados -->
                        <div class="automation-test-section">
                            <h4>üß™ Pruebas del Sistema de Automatizaci√≥n</h4>
                            <p>Prueba los diferentes tipos de flujos automatizados y validaciones legales</p>
                            <div class="automation-test-buttons">
                                <button class="btn btn-primary" onclick="testFullAutomationFlow()">
                                    <i class="fas fa-cogs"></i> Flujo Completo
                                </button>
                                <button class="btn btn-info" onclick="testQuestionnaireFlow()">
                                    <i class="fas fa-clipboard-list"></i> Solo Cuestionario
                                </button>
                                <button class="btn btn-warning" onclick="testDocumentFlow()">
                                    <i class="fas fa-file-contract"></i> Solo Documentos
                                </button>
                                <button class="btn btn-success" onclick="testLOPDCompliance()">
                                    <i class="fas fa-shield-alt"></i> Validar LOPD
                                </button>
                                <button class="btn btn-secondary" onclick="testStateTransitions()">
                                    <i class="fas fa-exchange-alt"></i> Estados de Cita
                                </button>
                            </div>
                        </div>

                        <!-- Historial de Automatizaci√≥n -->
                        <div class="automation-history">
                            <div class="history-header">
                                <h3>üìã Historial de Automatizaci√≥n</h3>
                                <button class="btn btn-sm btn-secondary" onclick="exportAutomationHistory()">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                            <div class="history-content" id="automationHistory">
                                <!-- El historial se cargar√° din√°micamente -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Documentos Section -->
                <section id="documentos" class="content-section">
                    <div class="section-header">
                        <h1>Gesti√≥n de Documentos</h1>
                        <div class="section-controls">
                            <button class="btn btn-primary" id="newDocumentBtn">
                                <i class="fas fa-plus"></i> Nuevo Documento
                            </button>
                        </div>
                    </div>

                    <div class="documents-container">
                        <div class="documents-tabs">
                            <button class="tab-btn active" data-tab="plantillas">Plantillas de Mensajes</button>
                            <button class="tab-btn" data-tab="cuestionarios">Cuestionarios</button>
                            <button class="tab-btn" data-tab="consentimientos">Consentimientos</button>
                            <button class="tab-btn" data-tab="otros">Otros Documentos</button>
                        </div>

                        <div class="tab-content">
                            <div id="plantillas" class="tab-panel active">
                                <div class="documents-grid" id="templatesList">
                                    <!-- Templates will be populated by JavaScript -->
                                </div>
                            </div>
                            <div id="cuestionarios" class="tab-panel">
                                <div class="documents-grid" id="questionnairesList">
                                    <!-- Questionnaires will be populated by JavaScript -->
                                </div>
                            </div>
                            <div id="consentimientos" class="tab-panel">
                                <div class="documents-grid" id="consentsList">
                                    <!-- Consents will be populated by JavaScript -->
                                </div>
                            </div>
                            <div id="otros" class="tab-panel">
                                <div class="documents-grid" id="othersList">
                                    <!-- Others will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Facturas Section -->
                <section id="facturas" class="content-section">
                    <div class="section-header">
                        <h1>Facturaci√≥n Verifactu</h1>
                        <div class="section-controls">
                            <button class="btn btn-primary" id="newInvoiceBtn">
                                <i class="fas fa-plus"></i> Nueva Factura
                            </button>
                        </div>
                    </div>

                    <div class="invoices-container">
                        <div class="invoices-filters">
                            <div class="filter-group">
                                <input type="text" id="invoiceSearch" placeholder="Buscar facturas...">
                                <select id="invoiceStatus">
                                    <option value="">Todos los estados</option>
                                    <option value="pending">Pendiente</option>
                                    <option value="sent">Enviada</option>
                                    <option value="paid">Pagada</option>
                                </select>
                            </div>
                        </div>

                        <div class="invoices-list" id="invoicesList">
                            <!-- Invoices will be populated by JavaScript -->
                        </div>
                    </div>
                </section>

                <!-- Contabilidad Section -->
                <section id="contabilidad" class="content-section">
                    <div class="section-header">
                        <h1>M√≥dulo de Contabilidad</h1>
                        <div class="section-controls">
                            <select id="accountingPeriod">
                                <option value="current-month">Mes Actual</option>
                                <option value="last-month">Mes Anterior</option>
                                <option value="current-year">A√±o Actual</option>
                            </select>
                        </div>
                    </div>

                    <div class="accounting-container">
                        <div class="accounting-dashboard">
                            <div class="summary-cards">
                                <div class="summary-card">
                                    <h3>Total Facturado</h3>
                                    <div class="amount">‚Ç¨34,560</div>
                                    <div class="change positive">+12.5% vs mes anterior</div>
                                </div>
                                <div class="summary-card">
                                    <h3>Pagos Pendientes</h3>
                                    <div class="amount">‚Ç¨8,230</div>
                                    <div class="change neutral">Sin cambios</div>
                                </div>
                                <div class="summary-card">
                                    <h3>Gastos del Mes</h3>
                                    <div class="amount">‚Ç¨12,890</div>
                                    <div class="change negative">+8.2% vs mes anterior</div>
                                </div>
                                <div class="summary-card">
                                    <h3>Beneficio Neto</h3>
                                    <div class="amount">‚Ç¨21,670</div>
                                    <div class="change positive">+15.3% vs mes anterior</div>
                                </div>
                            </div>

                            <div class="charts-section">
                                <div class="chart-container">
                                    <h3>Ingresos por Tratamiento</h3>
                                    <canvas id="incomeChart"></canvas>
                                </div>
                                <div class="chart-container">
                                    <h3>Evoluci√≥n Mensual</h3>
                                    <canvas id="monthlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Configuraci√≥n Section -->
                <section id="configuracion" class="content-section">
                    <div class="section-header">
                        <h1>Configuraci√≥n del Sistema</h1>
                    </div>

                    <div class="config-container">
                        <div class="config-tabs">
                            <button class="config-tab-btn active" data-tab="users">Usuarios y Permisos</button>
                            <button class="config-tab-btn" data-tab="clinic">Datos de la Cl√≠nica</button>
                            <button class="config-tab-btn" data-tab="integration">Integraciones</button>
                            <button class="config-tab-btn" data-tab="backup">Respaldos</button>
                        </div>

                        <div class="config-content">
                            <div id="users" class="config-panel active">
                                <div class="user-management">
                                    <h3>Gesti√≥n de Usuarios</h3>
                                    <div class="user-list" id="userList">
                                        <!-- Users will be populated by JavaScript -->
                                    </div>
                                    <button class="btn btn-primary" id="addUserBtn">
                                        <i class="fas fa-plus"></i> Agregar Usuario
                                    </button>
                                </div>
                            </div>

                            <div id="clinic" class="config-panel">
                                <form id="clinicForm" class="config-form">
                                    <div class="form-group">
                                        <label>Nombre de la Cl√≠nica</label>
                                        <input type="text" value="Rubio Garc√≠a Dental" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Direcci√≥n</label>
                                        <input type="text" value="Calle Example, 123" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Tel√©fono</label>
                                        <input type="tel" value="+34 912 345 678" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" value="info@rubiogarciadental.com" required>
                                    </div>
                                    <div class="form-group">
                                        <label>NIF/CIF</label>
                                        <input type="text" value="12345678A" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                </form>
                            </div>

                            <div id="integration" class="config-panel">
                                <h3>Configuraci√≥n de Integraciones</h3>
                                <div class="integration-list">
                                    <div class="integration-item">
                                        <div class="integration-info">
                                            <h4>Base de Datos Local</h4>
                                            <p>Sincronizaci√≥n con agenda local</p>
                                        </div>
                                        <div class="integration-status">
                                            <span class="status-indicator active"></span>
                                            <span>Conectado</span>
                                        </div>
                                    </div>
                                    <div class="integration-item">
                                        <div class="integration-info">
                                            <h4>AEAT Verifactu</h4>
                                            <p>Cumplimiento normativa espa√±ola</p>
                                        </div>
                                        <div class="integration-status">
                                            <span class="status-indicator active"></span>
                                            <span>Configurado</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="backup" class="config-panel">
                                <h3>Respaldos del Sistema</h3>
                                <div class="backup-controls">
                                    <button class="btn btn-primary" id="createBackup">
                                        <i class="fas fa-download"></i> Crear Respaldo
                                    </button>
                                    <button class="btn btn-outline" id="restoreBackup">
                                        <i class="fas fa-upload"></i> Restaurar Respaldo
                                    </button>
                                </div>
                                <div class="backup-list" id="backupList">
                                    <!-- Backup list will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modalContainer">
        <!-- New Appointment Modal -->
        <div id="appointmentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Nueva Cita</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="appointmentForm" class="modal-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Paciente</label>
                            <select name="patient" required>
                                <option value="">Seleccionar paciente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" name="date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hora</label>
                            <input type="time" name="time" required>
                        </div>
                        <div class="form-group">
                            <label>Duraci√≥n</label>
                            <select name="duration" required>
                                <option value="30">30 minutos</option>
                                <option value="60">1 hora</option>
                                <option value="90">1.5 horas</option>
                                <option value="120">2 horas</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tratamiento</label>
                        <select name="treatment" required>
                            <option value="">Seleccionar tratamiento</option>
                            <option value="consulta">Consulta General</option>
                            <option value="limpieza">Limpieza Dental</option>
                            <option value="implante">Implante</option>
                            <option value="ortodoncia">Ortodoncia</option>
                            <option value="endodoncia">Endodoncia</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea name="notes" rows="3" placeholder="Notas adicionales..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline modal-close">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Crear Cita</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Patient Modal -->
        <div id="patientModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Nuevo Paciente</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="patientForm" class="modal-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Apellidos</label>
                            <input type="text" name="surname" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" name="phone" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" name="address">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha de Nacimiento</label>
                            <input type="date" name="birthDate">
                        </div>
                        <div class="form-group">
                            <label>DNI</label>
                            <input type="text" name="dni">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notas M√©dicas</label>
                        <textarea name="medicalNotes" rows="3" placeholder="Alergias, medicaci√≥n, etc."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline modal-close">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Crear Paciente</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Invoice Modal -->
        <div id="invoiceModal" class="modal">
            <div class="modal-content large">
                <div class="modal-header">
                    <h2>Nueva Factura</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="invoiceForm" class="modal-form">
                    <div class="invoice-preview">
                        <div class="invoice-header">
                            <div class="clinic-info">
                                <h3>Rubio Garc√≠a Dental</h3>
                                <p>Calle Example, 123</p>
                                <p>Tel: +34 912 345 678</p>
                                <p>NIF: 12345678A</p>
                            </div>
                            <div class="invoice-title">
                                <h2>FACTURA</h2>
                                <div class="invoice-number">
                                    <label>N√∫mero:</label>
                                    <input type="text" name="invoiceNumber" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="invoice-customer">
                            <div class="customer-info">
                                <h4>Datos del Cliente</h4>
                                <input type="text" name="customerName" placeholder="Nombre del cliente" required>
                                <input type="text" name="customerAddress" placeholder="Direcci√≥n">
                                <input type="text" name="customerNif" placeholder="NIF/CIF">
                            </div>
                        </div>

                        <div class="invoice-items">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>Cantidad</th>
                                        <th>Precio</th>
                                        <th>IVA</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceItems">
                                    <tr>
                                        <td><input type="text" name="concept[]" placeholder="Descripci√≥n del servicio"></td>
                                        <td><input type="number" name="quantity[]" value="1" min="1"></td>
                                        <td><input type="number" name="price[]" step="0.01" min="0"></td>
                                        <td>
                                            <select name="iva[]">
                                                <option value="0">0%</option>
                                                <option value="4">4%</option>
                                                <option value="10">10%</option>
                                                <option value="21" selected>21%</option>
                                            </select>
                                        </td>
                                        <td class="item-total">0.00‚Ç¨</td>
                                        <td><button type="button" class="btn-remove-item">&times;</button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-sm btn-outline" id="addItem">+ Agregar L√≠nea</button>
                        </div>

                        <div class="invoice-totals">
                            <div class="total-line">
                                <span>Subtotal:</span>
                                <span id="subtotal">0.00‚Ç¨</span>
                            </div>
                            <div class="total-line">
                                <span>IVA:</span>
                                <span id="totalIva">0.00‚Ç¨</span>
                            </div>
                            <div class="total-line total-final">
                                <span>Total:</span>
                                <span id="totalAmount">0.00‚Ç¨</span>
                            </div>
                        </div>

                        <div class="verifactu-compliance">
                            <div class="qr-placeholder">
                                <div class="qr-code">QR Verifactu</div>
                            </div>
                            <div class="verifactu-text">
                                <p><strong>Factura verificable en la sede electr√≥nica de la AEAT</strong></p>
                                <p>C√≥digo Hash: <span id="invoiceHash">Generando...</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline modal-close">Cancelar</button>
                        <button type="button" class="btn btn-secondary" id="previewInvoice">Vista Previa</button>
                        <button type="submit" class="btn btn-primary">Crear Factura</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Database Integration Scripts -->
    <script src="scripts/database-config.js"></script>
    <script src="scripts/database-manager.js"></script>
    
    <!-- Core Application Scripts -->
    <script src="scripts/main.js"></script>
    <script src="scripts/calendar.js"></script>
    <script src="scripts/whatsapp.js"></script>
    <script src="scripts/ai-agent.js"></script>
    <script src="scripts/invoices.js"></script>
    <script src="scripts/accounting.js"></script>
    
    <!-- Testing Scripts -->
    <script src="scripts/confirmation-test.js"></script>
    
    <!-- Appointment Confirmation System -->
    <script src="scripts/appointment-confirmation-system.js"></script>
    <script src="scripts/confirmation-ui-helpers.js"></script>
    
    <!-- Advanced Automation System -->
    <script src="scripts/advanced-automation-system.js"></script>
    <script src="scripts/automation-ui-helpers.js"></script>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>
</body>
</html>